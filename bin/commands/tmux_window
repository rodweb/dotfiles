#!/usr/bin/env bash
is_menu="${MENU:-0}"
selected="$1"

function get_options() {
  tmux list-windows -a -F '#{window_active},#{window_name} [#{session_name}]' \
    | sort -nr \
    | cut -d ',' -f2
  }

function filter() {
  dmenu -p "window:"
}

function execute() {
  echo "$1"
  if [[ "$1" =~ ([^\ ]+)\ \[([^\]]+)\] ]]; then
    window_name=${BASH_REMATCH[1]}
    session_name=${BASH_REMATCH[2]}
  fi
  [[ -z "$window_name" ]] && exit
  ror-tmux &
  sleep 0.3
  tmux switch -t "$session_name"
  tmux select-window -t "$window_name"
  exit
}

[[ -n "$selected" ]] && execute "$selected"

if [[ "$is_menu" -eq "1" ]]; then
  get_options
  exit
fi

selected=$(get_options | filter)
[[ -z "$selected" ]] && exit
"$0" "$selected"
